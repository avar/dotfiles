FSync no
BufferLimit 100M

IMAPAccount work
    # Generic options
    Timeout 0
    # User authentication
    AuthMech LOGIN
    User aearnfjord
    PassCmd "stat --format=%a ~/.mbsync-pass | grep -qx 600 && cat ~/.password/work-ldap"
    # Who do we talk to?
    Host 127.0.0.1
    Port 1430
    SSLType None
    # Don't do compression for tcpflow inspectability. A no-op sync
    # goes from 6s to 10s with this.
    DisableExtensions COMPRESS=DEFLATE
    # This would be directly talking to imap.booking.com not through
    # stunnel.
    #Host eximap-eur.booking.com
    #Port 993
    #SSLType IMAPS
    #CertificateFile /etc/ssl/certs/ca-certificates.crt

IMAPStore work-remote
    Account work

MaildirStore work-local
    Path ~/Maildir/work/
    Inbox ~/Maildir/work/INBOX

Channel work
    Master :work-remote:
    Slave :work-local:
    Patterns INBOX Sent Drafts Trash Archives
    Create Both
    Sync Pull New ReNew Flags
    Sync Push Delete Flags
    Expunge Master
    SyncState *

# Manually test IMAP, worked with Cyrus:
#
#     openssl s_client -connect imap.booking.com:993 -quiet
#     a1 LOGIN aearnfjord <password>
#     a1 LIST "" "*"
#     a1 EXAMINE INBOX
#
# Resources:
#
# - http://www.anta.net/misc/telnet-troubleshooting/imap.shtml
# - http://www.troubleshooters.com/emailtech/imap_troubleshooting.htm

# Cyrus -> Exchange migration notes:
#
# First thing I tried:
#
#    1. rsync -av --progress ~/Maildir/ ~/Maildir.2016-07-11
#    2. find ~/Maildir -iname '*state*' -exec rm -v {} \;
#    3. until mbsync --verbose --pull work; do echo "Failed at $(date)"; sleep 1; done
#
# That didn't work, it initially synced like ~500 messages, but then
# it seems to spend hours initially updating the journal and then get
# this:
#
#    Warning: lost track of 925645 pulled message(s)
#    Socket error: write to 127.0.0.1 (127.0.0.1:1430): Connection reset by peer
#
# And subsequently because I'm running this in a loop the command
# takes ~20 minutes but then always fails with:
#
#    slave: 577558 messages, 443643 recent
#    Socket error: write to 127.0.0.1 (127.0.0.1:1430): Connection reset by peer
#
# Second try, based on:
# https://sourceforge.net/p/isync/mailman/message/31260886/
#
# 1. $ grep 1287391201 $(find Maildir -name '*mb*')
#    Maildir/work/INBOX/.mbsyncstate:MasterUidValidity 1287391201
#    Maildir/work/Drafts/.mbsyncstate:MasterUidValidity 1287391201
#    $ perl -pi -e 's/MasterUidValidity 1287391201/MasterUidValidity 613272/g' $(find Maildir -name '*mb*')
#    $ grep 613272 $(find Maildir -name '*mb*')
#    Maildir/work/INBOX/.mbsyncstate:MasterUidValidity 613272
#    Maildir/work/Drafts/.mbsyncstate:MasterUidValidity 613272
#
#    # That didn't catch some of them. Fixed with:
#    $ grep MasterUid $(find Maildir -name '*mb*')
#    Maildir/work/Trash/.mbsyncstate:MasterUidValidity 1287391202
#    Maildir/work/INBOX/.mbsyncstate:MasterUidValidity 613272
#    Maildir/work/Archives/.mbsyncstate:MasterUidValidity 1288279003
#    Maildir/work/Sent/.mbsyncstate:MasterUidValidity 1287391202
#    Maildir/work/Drafts/.mbsyncstate:MasterUidValidity 613272
#    $ perl -pi -e 's/MasterUidValidity \d+/MasterUidValidity 613272/g' $(find Maildir -name '*mb*')
#    $ grep MasterUid $(find Maildir -name '*mb*')
#    Maildir/work/Trash/.mbsyncstate:MasterUidValidity 613272
#    Maildir/work/INBOX/.mbsyncstate:MasterUidValidity 613272
#    Maildir/work/Archives/.mbsyncstate:MasterUidValidity 613272
#    Maildir/work/Sent/.mbsyncstate:MasterUidValidity 613272
#    Maildir/work/Drafts/.mbsyncstate:MasterUidValidity 613272
#
# But it always keeps getting new UIDs:
#
#     Error: UIDVALIDITY of master changed (got 597077, expected 613272)
#     Error: UIDVALIDITY of master changed (got 613278, expected 613272)
#
# etc.
#
# Third try, try a new sync, moved ~/Maildir out of the way, created
# ~/Maildir/work and:
#
#    $ until mbsync --verbose --pull work; do echo "Failed at $(date)"; sleep 1; done
#
# That gets 500 messages and then:
#
#    C: 0/1  B: 0/5  M: +0/0 *0/0 #0/0  S: +500/958585 *0/0 #0/0
#    Socket error from 127.0.0.1 (127.0.0.1:1430): Connection reset by peer
#    C: 1/1  B: 1/5  M: +0/0 *0/0 #0/0  S: +500/958585 *0/0 #0/0
#
# The next run:
#
#    slave: 500 messages, 0 recent
#    Warning: lost track of 958085 pulled message(s)
#
# Seems to be hanging, and strace(1) shows nothing.
#
# More resources:
#
#   - IMAP / SMTP / LDAP search config:
#     https://wiki.booking.com/display/~adiab/Thunderbird+Configuration+For+Exchange+Users
