#!/bin/sh


for d in test-results/*.leak
do
	grep -h DEDUP $d/* | sort -u | tr '\n' ' ' &&
	printf "\t" &&
	echo $d
done | perl -nE '
	use strict;
	use warnings;
	our %ddt;
	chomp;
	my ($ddt, $n) = split /\t/;
	$ddt =~ s/\s*$//;
	$ddt =~ s/(DEDUP_TOKEN:) /$1/g;
	$n =~ s[test-results/][];
	$n =~ s[\.leak$][.sh];

	push @{$ddt{$ddt}} => $n;

	END {
		for my $k (sort { @{$ddt{$b}} <=> @{$ddt{$a}} } keys %ddt) {
			my $n = @{$ddt{$k}};
			my @leaks = split / /, $k;
			my $n_leaks = @leaks;

			say "$n test would pass if " . ($n_leaks == 1 ? "this leak" : "these $n_leaks") . " were fixed:";
			say " ==> $_" for @leaks;

			say "    => $_" for @{$ddt{$k}};

		}
	}'
