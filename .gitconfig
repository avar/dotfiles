;; User
[user]
	name = Ævar Arnfjörð Bjarmason
	email = avarab@gmail.com
[github]
	login = avar
[include]
	path = ~/.gitconfig.d/github-token
[includeIf "gitdir:~/g/perl/"]
	path = ~/.gitconfig.d/user-perl

;; Core
[core]
	untrackedCache = true
	splitIndex = false

;; Core -- UI
[help]
	autocorrect = 0
[color]
	ui = auto

;; Core commands -- status
[status]
	showStash = true

;; Core commands -- network
[push]
	default = upstream
[fetch]
	output = compact
[pull]
	rebase = true
[sendemail]
	smtpserver = smtp.gmail.com
	smtpEncryption = ssl
	smtpuser = avarab@gmail.com
	confirm = always

;; Core commands -- diff
[diff]
	indentHeuristic = true
	colorMoved = true
[color "diff"]
	;; Don't be so invasive about coloring ^M when I'm editing
	;; files that are supposed to have \r\n.
	whitespace = 0

;; Core commands -- rebase / merge / am
[rebase]
	autosquash = true
	;; Show stat output on rebase to show what changed
	stat = true
[merge]
	;; Have "git merge" do what "git pull" would have done
	defaultToUpstream = true
[rerere]
	enabled = true
	autoUpdate = true
[gc]
	;; Maybe I'll leave that topic branch for a while, but it
	;; conflicts with my other own work, not upstream's
	rerereResolved = "1 year ago"
[mailinfo]
	scissors = true

;; Core commands -- checkout / switch etc.
[checkout]
	defaultRemote = origin

;; Core commands -- [creating] objects
[commit]
        ;; See https://public-inbox.org/git/20190520182353.22221-1-matheus.bernardino@usp.br/
	verbose = true
[tag]
	sort = version:refname

;; Core commands -- History traversal
[log]
	;; Show tags and other references in "git log"
	decorate = short
	;; Abbreviate commits by default. I.e. don't show a full SHA1
	abbrevCommit = true

;; Core commands -- Misc
[grep]
	patternType = perl

;; Aliases
[alias]
        ;; Invoke an arbitrary program with git config. See
        ;; https://lore.kernel.org/git/87h7oswepj.fsf@evledraar.gmail.com/
        sh = !sh
	;; Debugging (see GIT_* vars)
	env = !env --null | perl -n0E 'say if /^GIT/'

	;; Lazyness
	st = status --short
	ci = commit
	co = checkout
	sm = submodule
	chrp = cherry-pick
	sl = shortlog

	;; Parellel fetch
	pfetch = !git fetch --all --jobs=$(nproc)

	;; Submodules
	sm-init = !git submodule update --init
	; Try to update all the submodules, doing some guesswork to get branch names
	sm-pull-all = !git submodule foreach 'git checkout $(NAME=$name git sm-mainbranch) && git pull'
	; Manually specify a branch from the main config, or try to guess it
	sm-mainbranch = !git config --file ../.gitmodules submodule.$NAME.branch || git describe --all --always | sed 's!^heads/!!'

        ;; Commit
        cif = commit --fixup
        cis = commit --squash
        ca = commit --amend
        cane = commit --amend --no-edit

        ;; Rebase
        r = rebase
        ri = rebase -i
        rc = rebase --continue
        rs = rebase --skip
        ra = rebase --abort

	;; Diff
	di     = diff -M -p --stat
	diw    = !git di -w
	diww   = !git diw --word-diff=color
	diwwd  = !git diww --word-diff-regex=.
	dis    = !git di --staged
	disw   = !git diw --staged
	disww  = !git diww --staged
	diswwd = !git diwwd --staged

	;; Show
	s      = show -M -p --stat
	sw     = !git s -w
	sww    = !git sw --word-diff=color
	swwd   = !git sww --word-diff-regex=.

	;; Handy tools
	review = "!f() { for rev in $(git rev-list --reverse $@); do LESS='--IGNORE-CASE --LONG-PROMPT --QUIET --chop-long-lines --RAW-CONTROL-CHARS' git show --stat -p -M $rev; done; }; f"
        rw = review        
        rwu = review @{u}..

        ;; Git doesn't have a one-shot command to copy a branch & its
        ;; config to a new location.
        cp-branch = "!f() { git branch -c $1 $2 && git checkout $2; }; f"

	;; Working on git.git & other things using "reference"
        reference = !git --no-pager show -s --pretty=reference
	git-commit-summary = !git reference

	;; Like push but harder
	thrust = "!f() { until (sleep 0.5 && git push); do git pull --rebase; done; }; f"

        ;; per-project
        gitaly-make-test-tag-branch = "!f() { TEST_OPTIONS=\"-run \\\"Update|Create|Delete|Tag|Branch\\\"\" TEST_PACKAGES=\"./internal/git/updateref ./internal/gitaly/service/operations\" make test; }; f"

;; 3rd party tools
[annex]
	backends = SHA256E SHA256
